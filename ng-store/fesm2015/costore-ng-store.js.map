{"version":3,"file":"costore-ng-store.js","sources":["ng://@costore/ng-store/lib/store.token.ts","ng://@costore/ng-store/lib/core/store.ts","ng://@costore/ng-store/lib/store.service.ts","ng://@costore/ng-store/lib/decorators/use-state.ts","ng://@costore/ng-store/lib/plugins/keeper.ts","ng://@costore/ng-store/lib/plugins/logger.ts","ng://@costore/ng-store/lib/plugins/undoable.ts"],"sourcesContent":["import { InjectionToken } from '@angular/core';\r\nimport { StateConfig } from './models';\r\n\r\nexport const STORE_TOKEN = new InjectionToken<StateConfig[]>('STORE_TOKEN');\r\n","import { Actions, StateConfig, DefaultActions } from '../models';\r\n\r\nexport class Store {\r\n  private _state: { [key: string]: any } = {};\r\n  get state() {\r\n    return this._state;\r\n  }\r\n\r\n  private _actions: Actions = {};\r\n\r\n  constructor(private config: StateConfig[]) {\r\n    this.config.forEach(({ name, actions, plugins }) => {\r\n      if (plugins) plugins.forEach(plugin => plugin(name, actions));\r\n      this._actions[name] = actions;\r\n\r\n      if (actions.has('@INIT')) this.dispatch(name, '@INIT');\r\n    });\r\n  }\r\n\r\n  dispatch(key: string, action: DefaultActions, data?: any) {\r\n    const actionFn = this._actions[key].get(action);\r\n    const result = actionFn(this.state[key], data);\r\n    const { [key]: k, ...stateWOcurrentKey } = this.state;\r\n\r\n    this._state = action !== '@DESTROY' ? { ...stateWOcurrentKey, [key]: result } : { ...stateWOcurrentKey };\r\n  }\r\n}\r\n","import { Inject, Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs/internal/BehaviorSubject';\r\nimport { distinctUntilChanged } from 'rxjs/internal/operators/distinctUntilChanged';\r\nimport { pluck } from 'rxjs/internal/operators/pluck';\r\nimport { STORE_TOKEN } from './store.token';\r\nimport { StateConfig } from './models';\r\nimport { Store } from './core/store';\r\n\r\n// @dynamic\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StoreService {\r\n  private static _store: Store;\r\n  private static _stateSubject: BehaviorSubject<{ [key: string]: any }>;\r\n\r\n  constructor(@Inject(STORE_TOKEN) private config: StateConfig[]) {\r\n    StoreService._store = new Store(this.config);\r\n    StoreService._stateSubject = new BehaviorSubject(StoreService._store.state);\r\n  }\r\n\r\n  public static use(key: string) {\r\n    return {\r\n      observable: this._stateSubject.pipe(pluck(key), distinctUntilChanged()),\r\n      dispatch: (action, data?) => {\r\n        this._store.dispatch(key, action, data);\r\n        this._stateSubject.next(this._store.state);\r\n      },\r\n      getValue: () => this._stateSubject.value[key]\r\n    };\r\n  }\r\n}\r\n","import { StoreService } from '../store.service';\r\n\r\nexport function UseState(stateName: string) {\r\n  return function(target: any, propKey: string): void {\r\n    Object.defineProperties(target, {\r\n      [propKey]: {\r\n        get() {\r\n          return StoreService.use(stateName);\r\n        }\r\n      }\r\n    });\r\n  };\r\n}\r\n","export const keeper = () => {\r\n  return function(name, actions: Map<string, (state: any, data?: any) => any>) {\r\n    const saved = JSON.parse(localStorage.getItem(name));\r\n    actions.set('@LOAD', () => saved);\r\n\r\n    if (saved) actions.set('@INIT', () => actions.get('@LOAD')(null));\r\n\r\n    actions.forEach((actionFn, action) => {\r\n      if (action === '@INIT') return;\r\n\r\n      actions.set(action, (state, data) => {\r\n        const res = actionFn(state, data);\r\n        localStorage.setItem(name, JSON.stringify(res));\r\n        return res;\r\n      });\r\n    });\r\n\r\n    return actions;\r\n  };\r\n};\r\n","function log(key, action, value) {\r\n  // prettier-ignore\r\n  console.log(\r\n    '%c' + `[${key}]` + ' %c' + action, \r\n    'color: #070', 'color: #070; font-weight: 700', \r\n    value\r\n    );\r\n}\r\n\r\nexport const logger = () => {\r\n  return function(name, actions: Map<string, (state: any, data?: any) => any>) {\r\n    actions.forEach((actionFn, action) => {\r\n      actions.set(action, (state, data) => {\r\n        const res = actionFn(state, data);\r\n        log(name, action, res);\r\n        return res;\r\n      });\r\n    });\r\n\r\n    return actions;\r\n  };\r\n};\r\n","export const undoable = (config?) => {\r\n  return function(name, actions: Map<string, (state: any, data?: any) => any>) {\r\n    actions.forEach((actionFn, action) => {\r\n      actions.set(action, (state, data?) => {\r\n        if (!state) state = { past: [], present: null, future: [] };\r\n        const newState = actionFn(state.present, data);\r\n\r\n        return {\r\n          past: [...state.past, state.present],\r\n          present: newState,\r\n          future: []\r\n        };\r\n      });\r\n    });\r\n\r\n    actions.set('@UNDO', ({ past, present, future }) => {\r\n      if (!past.length) return { past, present, future };\r\n\r\n      const previous = past[past.length - 1];\r\n      const newPast = past.slice(0, past.length - 1);\r\n      return {\r\n        past: newPast,\r\n        present: previous,\r\n        future: [present, ...future]\r\n      };\r\n    });\r\n\r\n    actions.set('@REDO', ({ past, present, future }) => {\r\n      if (!future.length) return { past, present, future };\r\n\r\n      const next = future[0];\r\n      const newFuture = future.slice(1);\r\n      return {\r\n        past: [...past, present],\r\n        present: next,\r\n        future: newFuture\r\n      };\r\n    });\r\n\r\n    return actions;\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}